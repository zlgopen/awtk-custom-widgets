# 自定义分段式脏矩形控件

​	由于三缓冲的状态下，是无法启用 awtk 的默认脏矩形机制，但是脏矩形机制可以大幅度提高绘图效率，所以就写了一个自定义分段式脏矩形控件来满需这个需求，同时该控件只适用于顺序切换缓冲区的三缓冲机制。

​	自定义分段式脏矩形控件分为 dirty_rect_view 控件和 dirty_rect_view_item 控件，而  dirty_rect_view 控件是作为父集，dirty_rect_view_item 控件为子集。

​	自定义分段式脏矩形控件，会根据 dirty_rect_view_item 控件为默认的绘制区域（可能的脏矩形区域）， dirty_rect_view 控件遍历 dirty_rect_view_item 控件下面的所以子控件，然后判断该区域是否需要重绘，如果需要就重绘，不需要就不重绘，如下的 xml 代码：

``` xml
<window anim_hint="htranslate" style:normal:bg_color="#00000000">
  <dirty_rect_view x="0" y="0" w="100%" h="100%" style:normal:bg_image="bg" style:normal:bg_color="#00000000" enable_dirty_rect="true" lcd_buff_number="3" >
  
  <dirty_rect_view_item x="0" y="30" w="240" h="240" invalidate_background="false" >
	  <guage x="0" y="0" w="100%" h="100%" image="guage_bg" >
		<guage_pointer x="c" y="50" w="24" h="140" value="-128" image="guage_pointer" 
			animation="value(from=-128, to=128, yoyo_times=0, duration=3000, auto_destroy=false)"/>
	  </guage>
  </dirty_rect_view_item>
  
  <dirty_rect_view_item x="c" y="m" w="300" h="300" invalidate_background="false" >
	  <time_clock x="0" y="0" w="100%" h="100%" bg_image="clock_bg" image="clock" 
		hour_image="clock_hour" minute_image="clock_minute" second_image="clock_second" 
		hour_anchor_x="0.5" hour_anchor_y="72px"
		minute_anchor_x="0.5" minute_anchor_y="129px"
		second_anchor_x="0.5" second_anchor_y="148px"/>
  </dirty_rect_view_item>

   <dirty_rect_view_item x="r" y="bottom" w="60" h="48" invalidate_background="false" >
      <image_value x="0" y="0" w="100%" h="100%" value="0" format="%02d" image="num_"
        animation="value(from=10, to=100, yoyo_times=0, duration=100000)"/>
  </dirty_rect_view_item>
  
  </dirty_rect_view>
</window>
```

​	在上面的 UI 中可以看到，定义了 3 个 dirty_rect_view_item 控件（3 个可能的脏矩形区域），然后 dirty_rect_view 控件通过 dirty_rect_view_item 控件来判断是否需要重绘，这样就可以实现自定义的脏矩形效果了，当如果程序中是支持 awtk 的脏矩形机制的话，dirty_rect_view 控件还会自动把 awtk 本身的脏矩形和 dirty_rect_view_item 控件区域做并集，减低绘图区域 。

### 一，dirty_rect_view 控件

​	dirty_rect_view 控件作为自定义分段式脏矩形控件的父集，主要是负责判断哪个区域刷新，哪个区域不刷新的，同时会根据刷新的区域刷新对应的背景图区域，例如 A 区域刷新了，那么 A 区域对应的 dirty_rect_view 控件背景图区域也会刷新（会根据 dirty_rect_view_item 控件的 invalidate_background 来决定的）。

​	下表是 dirty_rect_view 控件的属性。

| 属性              | 用途                                                         |
| ----------------- | ------------------------------------------------------------ |
| enable_dirty_rect | 是否开启自定义脏矩形                                         |
| lcd_buff_number   | lcd 的缓冲 buff 个数，注意 lcd 的缓冲一定是要按照顺序来切换，否则会乱的 |

### 二，dirty_rect_view_item 控件

​	dirty_rect_view_item 控件作为自定义分段式脏矩形控件的子集，主要是确定那个区域为可能的脏矩形区域，给父集提供准确的坐标数据，最终执行绘图的也是 dirty_rect_view_item 控件。

​	下表是 dirty_rect_view_item 控件属性

| 属性                  | 用途                                                         |
| --------------------- | ------------------------------------------------------------ |
| invalidate_background | 是否让 dirty_rect_view 控件绘制自身控件区域的背景图，如果自身的控件需要和背景图做融合的话，就只能设置为 TRUE（让 dirty_rect_view 控件刷新其背景图）。 |

> 备注：由于有可能出现 dirty_rect_view_item 控件会把整个区域填充满的（整个区域都不需要显示背景图），所以这个时候就不需要绘制背景图了，所以就可以把 invalidate_background 设置为 false，减少重复绘制的地方，提高绘制效率。